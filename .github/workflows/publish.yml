name: Publish Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'cart-service/**'
      - 'inventory-service/**'
      - 'order-service/**'
      - '.github/workflows/publish.yml'

jobs:
  # JOB 1: Detect which folders changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      cart: ${{ steps.filter.outputs.cart }}
      inventory: ${{ steps.filter.outputs.inventory }}
      order: ${{ steps.filter.outputs.order }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cart:
              - 'cart-service/**'
            inventory:
              - 'inventory-service/**'
            order:
              - 'order-service/**'

  # JOB 2: Build Cart Service (Only if changed)
  build-cart:
    needs: changes
    if: ${{ needs.changes.outputs.cart == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}/cart-service
          tags: |
            type=sha,format=long
            latest
      - uses: docker/build-push-action@v5
        with:
          context: ./cart-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}

  # JOB 3: Build Inventory Service (Only if changed)
  build-inventory:
    needs: changes
    if: ${{ needs.changes.outputs.inventory == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}/inventory-service
          tags: |
            type=sha,format=long
            latest
      - uses: docker/build-push-action@v5
        with:
          context: ./inventory-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}

  # JOB 4: Build Order Service (Only if changed)
  build-order:
    needs: changes
    if: ${{ needs.changes.outputs.order == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}/order-service
          tags: |
            type=sha,format=long
            latest
      - uses: docker/build-push-action@v5
        with:
          context: ./order-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}

  # JOB 5: Update Helm Values
  update-helm-values:
    needs: [changes, build-cart, build-inventory, build-order]
    # Run if at least one build job ran (or simply always run to ensure sync, checking 'needs' status)
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Update Image Tags
        run: |
          SHA="sha-${{ github.sha }}"
          
          # Check which services changed and update ONLY their tags
          if [[ "${{ needs.changes.outputs.cart }}" == "true" ]]; then
             echo "Updating Cart Tag to $SHA"
             # Use accurate yq or sed. sed assumes structure.
             sed -i "/name: cart-service/,/imageTag:/s/imageTag: .*/imageTag: $SHA/" charts/shopping-microservices/values.yaml
          fi
          
          if [[ "${{ needs.changes.outputs.inventory }}" == "true" ]]; then
             echo "Updating Inventory Tag to $SHA"
             sed -i "/name: inventory-service/,/imageTag:/s/imageTag: .*/imageTag: $SHA/" charts/shopping-microservices/values.yaml
          fi
          
          if [[ "${{ needs.changes.outputs.order }}" == "true" ]]; then
             echo "Updating Order Tag to $SHA"
             sed -i "/name: order-service/,/imageTag:/s/imageTag: .*/imageTag: $SHA/" charts/shopping-microservices/values.yaml
          fi
          
          cat charts/shopping-microservices/values.yaml

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/shopping-microservices/values.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update image tags for changed services [skip ci]"
            git push
          fi
